#!/bin/bash
## actually run duply
BCKPNAME="$1"
shift
LOCKFILE="/var/lock/${BCKPNAME}.lock"
STATFILE="/var/log/backup/.success-${BCKPNAME}"
LOGFILE="/var/log/backup/${BCKPNAME}.log"
LOGFILE_E="/var/log/backup/${BCKPNAME}_error.log"
ACTION="$@"

<% if $runcondition != false -%>
#Test our run condition
[[ test <%= runcondition %> ]] || exit 0
<% end -%>

[[ -e $LOCKFILE ]] && exit 0 #exit if lockfile exists
touch $LOCKFILE

[[ -d /var/log/backup ]] || mkdir /var/log/backup

<% if $randomsleep != false -%>
#We shall sleep
sleep $(expr $RANDOM % <%= randomsleep %>);
<% end -%>

# HACKING THIS UNTIL DUPLICITY 0.6.20
# PASSPHRASE
export PASSPHRASE='<%= scope.lookupvar("gpg_password") %>'
nice ionice -c3 /usr/bin/duply $BCKPNAME $ACTION >>$LOGFILE 2>>$LOGFILE_E
if [ $? -eq 0 ]; then
    touch $STATFILE
fi
unset PASSPHRASE
echo -n "## ALL DONE: removing Lockfile: " >>$LOGFILE
rm -v $LOCKFILE >> $LOGFILE
